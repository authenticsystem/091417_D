<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../bower_components/neon-animation/neon-animatable.html">
<link rel="import" href="../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation-behavior.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../bower_components/salte-dialog/salte-dialog.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="image-resize.html">

<dom-module id="my-patients-new">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }

      app-header {
        color: rgb(255, 255, 255);
        background-color: #673AB7;
      }

      paper-icon-button.menu {
        margin-right: 16px;
      }

      app-drawer-layout:not([narrow]) [drawer-toggle] {
        display: none;
      }

      app-drawer {
        --app-drawer-content-container: {
          background-color: #F4F5F6;
        }
      }

      paper-item {
        height: 64px;
      }

      paper-item:hover {
        background: rgba(104, 58, 183, 0.26);
        cursor: pointer;
      }

      #item {
        height: 0;
      }

      .mnu {
        padding: 13px;
      }

      @media (min-width: 800px) {
        .footer {
          position: absolute;
          bottom: 16px;
          width: 100%;
        }
        .paper-fab-0 {
          position: absolute;
          left: 48px;
          bottom: 48px;
        }

        .paper-fab-1 {
          position: absolute;
          right: 48px;
          bottom: 48px;
        }

        #info {
          display: flex;
        }
      }

      @media (max-width: 800px) {
        .paper-fab-0 {
          position: absolute;
          left: 16px;
          bottom: 48px;
        }

        .paper-fab-1 {
          position: absolute;
          right: 16px;
          bottom: 48px;
        }

        .docu {
          margin-left: 16px;
          margin-right: 16px;
        }
      }

      .avatar {
        height: 50px;
        width: 50px;
        border-radius: 50%;
        box-sizing: border-box;
        background-color: #DDD;
      }

      .shortText,
      .longText {
        font-size: 14px;
      }

      .longText {
        color: gray;
        /* display: none; */
      }

      .action paper-button {
        height: 32px;
        font-size: 12px;
        font-weight: 400;
        width: 80px;
      }

      paper-button.green {
        background-color: var(--paper-green-500);
        color: white;
      }
    </style>

    <app-drawer-layout fullbleed narrow="{{narrow}}" id="drawerLayout">
      <app-drawer id="drawer" slot="drawer" swipe-open="[[narrow]]" align="right">
        <div class="mnu" role="listbox">
          <paper-item id="0">
            <div class="circle-mini-first" id="0">1</div>
            <span id="0">Profile Picture</span>
          </paper-item>

          <paper-item id="1">
            <div id="1" class="circle-mini">2</div>
            <span id="1">Basic Information</span>
          </paper-item>

          <paper-item id="2">
            <div id="2" class="circle-mini">3</div>
            <span id="2">Insurance</span>
          </paper-item>

          <paper-item id="3">
            <div id="3" class="circle-mini">4</div>
            <span id="3">In-case of Emergency</span>
          </paper-item>

          <paper-item id="4">
            <div id="4" class="circle-mini">5</div>
            <span id="4">Finalize</span>
          </paper-item>

          <paper-item>
            <div class="circle-mini-last">6</div>
            <span>Completed</span>
          </paper-item>
        </div>
      </app-drawer>

      <app-header-layout id="appheader" has-scrolling-region>
        <app-header fixed slot="header">
          <app-toolbar>
            <a href="{{prevRoute}}">
              <paper-icon-button noink class="menu" style="color: white;" icon="my-icons:arrow-back"></paper-icon-button>
            </a>
            <div main-title>Add {{_label(prevRoute)}}</div>
            <paper-icon-button class="menu" icon="my-icons:menu" drawer-toggle></paper-icon-button>
          </app-toolbar>
        </app-header>

        <neon-animated-pages selected="{{selectedPage}}" entry-animation="{{entryanimation}}" exit-animation="{{exitanimation}}">

          <neon-animatable>
            <div class="docu">
              <div class="docu-header">
                <span>1. Profile Picture</span>
              </div>

              <div class="details" style="text-align:center">
                <img id="profilePic" style="width:200px; height:200px; border-radius:50%;" src="../images/user.png">
                <br>
                <div class="upload-btn-wrapper">
                  <button class="btn">Upload profile picture</button>
                  <input on-change="_changepic" id="myfile" type="file" name="myfile" accept="image/*" />
                </div>
                <br>
              </div>
            </div>
          </neon-animatable>

          <neon-animatable>
            <div class="docu">
              <div class="docu-header">
                <span>2. Basic Information</span>
              </div>

              <div class="details">
                <div id="info">
                  <paper-input id="fname" value="{{fname}}" label="Firstname *" style="width:100%; margin-right:10px"></paper-input>
                  <paper-input id="mname" value="{{mname}}" label="Middlename *" style="width:100%; margin-right:10px"></paper-input>
                  <paper-input id="lname" value="{{lname}}" label="Lastname *" style="width:100%"></paper-input>
                </div>
                <paper-input id="email" value="{{email}}" label="E-mail Address"></paper-input>
                <div id="info">
                  <paper-input placeholder="mm/dd/yyyy" pattern="^(0[1-9]|1[0-2])[\/\-](0[1-9]|1\d|2\d|3[01])[\/\-]([0-9]{4})$" error-message="Invalid date format!"
                    value="{{bday}}" label="Birth date" style="width:100%;margin-right:10px"></paper-input>
                  <paper-input value="{{age}}" label="Age" style="width:100%;"></paper-input>
                </div>
                <div id="info">
                  <paper-dropdown-menu label="Marital Status" style="width:100%; margin-right:10px">
                    <paper-listbox slot="dropdown-content" style="cursor:pointer" attr-for-selected="name" selected="{{status}}" class="dropdown-content">
                      <paper-item id="item" name="Single">Single</paper-item>
                      <paper-item id="item" name="Married">Married</paper-item>
                      <paper-item id="item" name="Divorced">Divorced</paper-item>
                      <paper-item id="item" name="Separated">Separated</paper-item>
                      <paper-item id="item" name="Widowed">Widowed</paper-item>
                    </paper-listbox>
                  </paper-dropdown-menu>
                  <paper-dropdown-menu label="Gender" style="width:100%; margin-right:10px">
                    <paper-listbox slot="dropdown-content" style="cursor:pointer" attr-for-selected="name" selected="{{sex}}" class="dropdown-content">
                      <paper-item id="item" name="Male">Male</paper-item>
                      <paper-item id="item" name="Female">Female</paper-item>
                    </paper-listbox>
                  </paper-dropdown-menu>
                  <paper-input type="number" value="{{contact}}" label="Contact Number" style="width:100%;"></paper-input>
                </div>
                <paper-input value="{{address}}" label="Street Address"></paper-input>
                <paper-input value="{{occupation}}" label="Occupation"></paper-input>
                <div id="info">
                  <paper-input value="{{employer}}" label="Employer" style="width:100%; margin-right:10px"></paper-input>
                  <paper-input value="{{emp_phone}}" type="number" label="Employer Phone no." style="width:100%"></paper-input>
                </div>
                <br>
                <span>Referred to clinic by (choose one)</span>
                <div id="info">
                  <paper-radio-group style="font-size:14px;" selected="{{refer}}">
                    <paper-radio-button name="Dr">Dr</paper-radio-button>
                    <paper-radio-button name="Insurance plan">Insurance plan</paper-radio-button>
                    <paper-radio-button name="Hospital">Hospital</paper-radio-button>
                  </paper-radio-group>
                </div>
                <paper-input style="margin-top:-15px; display:none" id="doctor" value="{{doctor}}" label="Dr."></paper-input>
                <paper-input style="margin-top:-15px; display:none" id="hospital" value="{{hospital_name}}" label="Hospital name"></paper-input>
              </div>
            </div>
            <br>
            <br>
            <br>
          </neon-animatable>

          <neon-animatable>
            <div class="docu">

              <div class="docu-header">
                <span>3. Insurance</span>
              </div>

              <div class="details">
                <div id="info">
                  <paper-input value="{{card}}" Label="ID Card Number" style="width:100%; margin-right:10px"></paper-input>
                  <paper-input value="{{bdate}}" placeholder="mm/dd/yyyy" pattern="^(0[1-9]|1[0-2])[\/\-](0[1-9]|1\d|2\d|3[01])[\/\-]([0-9]{4})$"
                    error-message="Invalid date format!" Label="Birth date" style="width:100%;"></paper-input>
                </div>
                <paper-input value="{{in_address}}" Label="Address (If different)"></paper-input>
                <paper-input value="{{home_phone}}" type="number" Label="Home phone no."></paper-input>
                <paper-input value="{{indicate}}" Label="Please indicate primary insurance"></paper-input>
                <paper-input value="{{p_relation}}" Label="Relationship to patient"></paper-input>
              </div>

            </div>
            <br>
            <br>
            <br>
          </neon-animatable>

          <neon-animatable>
            <div class="docu">

              <div class="docu-header">
                <span>4. In-case of emergency</span>
              </div>

              <div class="details">
                <div id="info">
                  <paper-input value="{{name_e}}" label="Name of local friend or relative" style="width:100%; margin-right:10px"></paper-input>
                  <paper-input value="{{relation_e}}" label="Relationship to patient" style="width:100%;"></paper-input>
                </div>
                <div id="info">
                  <paper-input value="{{phone_e}}" type="number" label="Home phone no." style="width:100%; margin-right:10px"></paper-input>
                  <paper-input value="{{work_phone}}" type="number" label="Work phone no" style="width:100%;"></paper-input>
                </div>
              </div>

            </div>
            <br>
            <br>
            <br>
          </neon-animatable>

          <neon-animatable>
            <div style="margin-right:10px">
              <div style="float:right; padding:16px; margin-top:-34px;">
                <paper-input type="date" value="{{todayDate}}" style="width:150px">
                  <iron-icon icon="my-icons:event" slot="prefix"></iron-icon>
                </paper-input>
                <div style="margin-left:4px;margin-top:-10px;">
                  <span id="dateText" style="font-size:14px; color:gray; font-weight:50">{{text}}</span>
                </div>
              </div>
            </div>

            <div class="docu" style="margin-top:62px;">
              <div class="docu-header">5. Finalize</div>

              <div class="details">
                <img id="p_profile" src="../images/user.png" class="avatar">

                <table style="margin-bottom:6px;">
                  <tr>
                    <td>
                      <span class="longText">Firstname</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{fname}}</td>
                  </tr>
                  <tr>
                    <td>
                      <span class="longText">Middlename</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{mname}}</td>
                  </tr>
                  <tr>
                    <td>
                      <span class="longText">Lastname</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{lname}}</td>
                  </tr>
                  <tr>
                    <td>
                      <span class="longText">Email address</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{email}}</td>
                  </tr>
                  <tr>
                    <td>
                      <span class="longText">Birth date</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{bday}}</td>
                  </tr>
                  <tr>
                    <td>
                      <span class="longText">Age</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{age}}</td>
                  </tr>
                  <tr>
                    <td>
                      <span class="longText">Marital Status</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{status}}</td>
                  </tr>
                  <tr>
                    <td>
                      <span class="longText">Gender</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{sex}}</td>
                  </tr>
                  <tr>
                    <td>
                      <span class="longText">Contact no</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{contact}}</td>
                  </tr>
                  <tr>
                    <td>
                      <span class="longText">Street address</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{address}}</td>
                  </tr>
                  <tr>
                    <td>
                      <span class="longText">Occupation</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{occupation}}</td>
                  </tr>
                  <tr>
                    <td>
                      <span class="longText">Employer</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{employer}}</td>
                  </tr>
                  <tr>
                    <td>
                      <span class="longText">Employer phone no</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{emp_phone}}</td>
                  </tr>
                  <tr>
                    <td>
                      <span class="longText">Referred to clinic by</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{referredby}}</td>
                  </tr>
                </table>

                <div style="font-weight:bold; padding:5px; background:rgb(236, 235, 235)">Insurance</div>
                <table style="padding:6px">
                  <tr>
                    <td>
                      <span class="longText">ID Card no</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{card}}</td>
                  </tr>
                  <tr>
                    <td>
                      <span class="longText">Birth date</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{bdate}}</td>
                  </tr>
                  <tr>
                    <td>
                      <span class="longText">address</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{in_address}}</td>
                  </tr>
                  <tr>
                    <td>
                      <span class="longText">Home phone no</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{home_phone}}</td>
                  </tr>
                  <tr>
                    <td>
                      <span class="longText">Primary Insurance</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{indicate}}</td>
                  </tr>
                  <tr>
                    <td>
                      <span class="longText">Relationship to patient</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{p_relation}}</td>
                  </tr>
                </table>

                <div style="font-weight:bold; padding:5px; background:rgb(236, 235, 235)">In-case of emergency</div>
                <table style="padding:6px">
                  <tr>
                    <td>
                      <span class="longText">Name</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{name_e}}</td>
                  </tr>
                  <tr>
                    <td>
                      <span class="longText">Relationship to patient</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{relation_e}}</td>
                  </tr>
                  <tr>
                    <td>
                      <span class="longText">Home phone no</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{phone_e}}</td>
                  </tr>
                  <tr>
                    <td>
                      <span class="longText">Work phone no</span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="color:rgb(37, 37, 37)">{{work_phone}}</td>
                  </tr>
                </table>
              </div>
            </div>
            <br>
            <br>
            <br>
          </neon-animatable>

          <neon-animatable>
            <div class="docu">
              <div class="docu-header">6. Completed</div>

              <div class="details">
                <div id="saveSuccess" style="color: green; display:none;">Patient successfully saved.
                  <p id="p" style="margin-top:-4px">Patient no: <b style="color:#1976d2">[[patientNo]]</b></p>
                </div>
                <div id="saveLoad" style="color: orange; display:none;">Saving patient info.</div>
                <div id="saveFailed" style="color: red; display:none;">Opps! Something went wrong while saving patient.</div>
              </div>
            </div>
          </neon-animatable>

        </neon-animated-pages>

      </app-header-layout>

      <div class="footer">
        <div hidden$="[[favlefthide]]">
          <paper-fab style="background: #1976d2;" id="favleft" class="paper-fab-0" icon="my-icons:chevron-left" on-tap="_select1"></paper-fab>
        </div>
        <div hidden$="[[favrighthide]]">
          <paper-fab style="background: #1976d2;" id="favright" class="paper-fab-1" icon="my-icons:chevron-right" on-tap="_select2"></paper-fab>
        </div>
      </div>

    </app-drawer-layout>

    <salte-dialog no-auto-fullscreen id="queueDialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation">
      <h2 style="font-size: 16px; background: #1E88E5">Confirmation required!</h2>
      <span>Would you like to add this patient to queue?</span>
      <div class="buttons">
        <paper-button on-tap="_selectDate" dialog-confirm autofocus>Yes</paper-button>
        <paper-button on-tap="_addPatient" dialog-dismiss>No</paper-button>
      </div>
    </salte-dialog>

    <salte-dialog no-auto-fullscreen id="dateDialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation">
      <h2 style="font-size: 16px; background: #1E88E5">When?</h2>
      <span>
        <paper-input type="date" value="{{pickDate}}" label="Pick a date" always-float-label>
          <iron-icon icon="my-icons:event" slot="prefix"></iron-icon>
        </paper-input>
        <div style="margin-left:4px;margin-top:-6px;">
          <span id="pickDateText" style="font-size:14px; color:gray; font-weight:50">{{pickText}}</span>
        </div>
      </span>
      <div class="buttons">
        <paper-button id="dateDialogBtn" dialog-confirm autofocus on-tap="_queuePatient">OK</paper-button>
        <paper-button dialog-dismiss>Cancel</paper-button>
      </div>
    </salte-dialog>

  </template>

  <script>
    Polymer({
      is: 'my-patients-new',

      properties: {
        narrow: {
          type: Boolean,
          notify: true
        },
        myKey: String,
        prevRoute: String,
        myQueue: String,
        myLocation: String,
        myLocationCode: String,
        selectedPage: Number,
        entryanimation: {
          type: String,
          value: "slide-from-right-animation"
        },
        exitanimation: {
          type: String,
          value: "slide-left-animation"
        },
        favlefthide: {
          type: Boolean,
          value: true
        },
        favrighthide: {
          type: Boolean,
          value: true
        },
        profile: String,
        patientPushKey: String
      },

      observers: [
        'personalInfoChanged(fname, mname, lname, bday, age)',
        '_todayDateChanged(todayDate)',
        '_pickDateChanged(pickDate)',
        '_referChanged(refer)'
      ],

      ready() {
        this.selectedPage = 0;
        this.favrighthide = false;
        this.todayDate = this.formatTodayDate(new Date());
        this.pickDate = this.formatTodayDate(new Date());
      },

      _pickDateChanged(date) {
        if (date) {
          this.$.dateDialogBtn.disabled = false;
          Polymer.dom(this.root).querySelector("#pickDateText").setAttribute('style', 'font-size:14px;color:gray');
          this.pickText = this.formatWeekDate(date);
        }
        else {
          this.$.dateDialogBtn.disabled = true;
          Polymer.dom(this.root).querySelector("#pickDateText").setAttribute('style', 'font-size:12px;color:red');
          this.pickText = 'Please pick a date.';
        }
      },

      _todayDateChanged(date) {
        var monthNames = [
          "January", "February", "March",
          "April", "May", "June", "July",
          "August", "September", "October",
          "November", "December"
        ];

        var d = new Date(date);
        if (date) {
          Polymer.dom(this.root).querySelector("#dateText").setAttribute('style', 'font-size:14px;color:gray');
          this.text = monthNames[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
          this.favrighthide = false;
        }
        else {
          Polymer.dom(this.root).querySelector("#dateText").setAttribute('style', 'font-size:12px;color:red');
          this.text = 'Please choose date.';
          this.favrighthide = true;
        }
      },

      _referChanged(e) {
        if (e == 'Dr') {
          Polymer.dom(this.root).querySelector("#doctor").style.display = 'block';
          Polymer.dom(this.root).querySelector("#hospital").style.display = 'none';
          this.referredby = 'Dr. ' + this.doctor;
          this.hospital_name = '';
        }
        else if (e == 'Hospital') {
          Polymer.dom(this.root).querySelector("#hospital").style.display = 'block';
          Polymer.dom(this.root).querySelector("#doctor").style.display = 'none';
          this.doctor = '';
          this.hospital_name = this.hospital_name;
          this.referredby = this.hospital_name;
        }
        else {
          Polymer.dom(this.root).querySelector("#doctor").style.display = 'none';
          Polymer.dom(this.root).querySelector("#hospital").style.display = 'none';
          this.doctor = '';
          this.hospital_name = ''
          this.referredby = e;
        }
      },

      personalInfoChanged(fname, mname, lname, bday) {
        if (fname) this.fname = fname.toUpperCase();
        if (mname) this.mname = mname.toUpperCase();
        if (lname) this.lname = lname.toUpperCase();

        if (bday) {
          var newdateformat = /^([0-9]{4})[\/\-](0[1-9]|1[0-2])[\/\-](0[1-9]|1\d|2\d|3[01])$/;
          bday = this._formatToGDate(bday);
          if (bday.match(newdateformat)) {
            this.age = this._calculateAge(bday);
          }
          else {
            this.age = '';
          }
        }
        else {
          this.age = '';
        }

        if (!fname || !lname) {
          if (this.selectedPage === 1) {
            this.favrighthide = true;
          }
        }
        else {
          this.favrighthide = false;
        }
      },

      _formatToGDate(date) {
        // var [month, day, year] = date.split(/[\/\-]/);
        if (date) {
          var x = new Date(date);
          return x.getFullYear() + '-' + ('0' + (x.getMonth() + 1)).slice(-2) + '-' + ('0' + x.getDate()).slice(-2);
        } else {
          return "";
        }
      },

      _calculateAge(bday) {
        var daysBetweenDates;
        daysBetweenDates = function (d1, d2) {
          var diffDays, oneDay;
          oneDay = 24 * 60 * 60 * 1000;
          diffDays = (d2 - Date.parse(d1)) / oneDay;
          return diffDays;
        };

        var ageNum = daysBetweenDates(bday, new Date()) / 365;

        function N(num, places) {
          return +(Math.round(num + "e+" + places) + "e-" + places);
        }

        var x = N(ageNum, 3);

        if (x <= 0) return 0;
        else return x;
      },

      _label(e) {
        return e.charAt(1).toUpperCase() + e.slice(2).replace("s", "");
      },

      _changepic(e) {
        if (e.target.files.length > 0) {
          var img = Polymer.dom(this.root).querySelector("#profilePic");
          var i = Polymer.dom(this.root).querySelector("#p_profile");

          var reader = new FileReader();
          reader.onload = function (e) {
            img.src = e.target.result;
            i.src = e.target.result;
          };
          reader.readAsDataURL(e.target.files[0]);

          var profile = e.target.files[0];
          var pic_name = new Date().getTime() + '.' + profile.type.substring(6);
          var self = this;

          if (profile.size > 9999) {
            ImageTools.resize(profile, { width: 440, height: 400 }, function (blob, didItResize) {
              self.profile = { name: pic_name, blob: blob }
            });
          }
          else {
            self.profile = { name: pic_name, blob: profile }
          }
        }
        else {
          this.profile = null;
          Polymer.dom(this.root).querySelector("#profilePic").src = '../images/user.png';
          Polymer.dom(this.root).querySelector("#p_profile").src = '../images/user.png';
        }
      },

      toggleDrawer() {
        this.dispatchEvent(new CustomEvent('toggleDrawer', {
          bubbles: true, composed: true, detail: {
            narrow: this.$.narrow
          }
        }));
        this.$.narrow = !this.$.narrow;
      },

      _selectDate() {
        this.$.dateDialog.open();
      },

      formatWeekDate(date) {
        var monthNames = [
          "Jan", "Feb", "Mar",
          "Apr", "May", "Jun", "Jul",
          "Aug", "Sep", "Oct",
          "Nov", "Dec"
        ];

        var days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        // var now = new Date().toDateString();
        var d = new Date(date);

        return days[d.getDay()] + ', ' + d.getDate() + ' ' + monthNames[d.getMonth()] + ' ' + d.getFullYear();
      },

      formatTodayDate(date) {
        var monthNames = [
          "01", "02", "03",
          "04", "05", "06", "07",
          "08", "09", "10",
          "11", "12"
        ];

        var day = date.getDate();
        if (day < 10) { day = '0' + day };
        var monthIndex = date.getMonth();
        var year = date.getFullYear();

        return year + '-' + monthNames[monthIndex] + '-' + day;
      },

      _select1(e) {
        this.entryanimation = "slide-from-left-animation";
        this.exitanimation = "slide-right-animation";

        if (parseInt(this.selectedPage) <= 5) {
          if (parseInt(this.selectedPage) !== 0) {
            this.selectedPage = (parseInt(this.selectedPage) - 1);

            if (this.selectedPage === 0) {
              this.favlefthide = true;
            }

            if (this.selectedPage == 4) {
              this.favrighthide = true;
            }
            else {
              Polymer.dom(this.root).querySelector("#favright").setAttribute("style", "background: #1976d2;");
              Polymer.dom(this.root).querySelector("#favright").setAttribute("icon", "my-icons:chevron-right");
              this.favrighthide = false;
            }

          }
          else {
            this.favlefthide = true;
            this.favrighthide = false;
          }
        }
        else {
          this.selectedPage = 5;
        }

      },

      _select2(e) {
        this.entryanimation = "slide-from-right-animation";
        this.exitanimation = "slide-left-animation";

        if (parseInt(this.selectedPage) >= 0) {

          if (parseInt(this.selectedPage) == 0) {
            if (!this.fname || !this.lname) {
              this.favlefthide = false;
              this.favrighthide = true;
            }
            else {
              this.favlefthide = false;
              this.favrighthide = false;
            }
          }

          if (parseInt(this.selectedPage) == 3) {
            if (!this.todayDate) {
              this.favrighthide = true;
            }
            else {
              this.favrighthide = false;
            }
          }

          if (parseInt(this.selectedPage) == 4) {

            if (!this.myQueue) {
              if (this.myLocation == "(not set)") {
                this._insertNewPatient(false, this.myKey, '', '', '', '');
              }
              else {
                Polymer.dom(this.root).querySelector("#queueDialog").open();
              }
            }
            else {
              this.$.dateDialog.open();
            }
          }

          if (parseInt(this.selectedPage) < 4) {
            this.selectedPage = (parseInt(this.selectedPage) + 1);
          }

          if (parseInt(this.selectedPage) !== 5) {

            if (parseInt(this.selectedPage) == 4) {
              Polymer.dom(this.root).querySelector("#favright").setAttribute("style", "background: green;");
              Polymer.dom(this.root).querySelector("#favright").setAttribute("icon", "my-icons:done");
            }

            if (parseInt(this.selectedPage) == 5) {
              this.favlefthide = false;
              this.favrighthide = true;
            }
          }
        }
        else {
          this.selectedPage = 0;
          this.favlefthide = true;
          this.favrighthide = false;
        }
      },

      _addPatient() {
        this.favlefthide = true;
        this.favrighthide = true;
        this.selectedPage = (parseInt(this.selectedPage) + 1);

        this._insertNewPatient(false, this.myKey, '', '', '', '');
      },

      _queuePatient() {
        this.favlefthide = true;
        this.favrighthide = true;
        this.selectedPage = (parseInt(this.selectedPage) + 1);
        this._insertNewPatient(true, this.myKey, this.myLocation, this.myLocationCode, 'yes', this.pickDate);
      },

      _insertNewPatient(isQue, mykey, myLocation, myLocationCode, add2Que, pickDate) {
        var saveLoad = Polymer.dom(this.root).querySelector("#saveLoad");
        var saveSucc = Polymer.dom(this.root).querySelector("#saveSuccess");
        var saveErr = Polymer.dom(this.root).querySelector("#saveFailed");
        var today = this.todayDate;
        var self = this;

        var ref = firebase.database().ref("/" + mykey + "/patients");
        var noRef = firebase.database().ref("/" + mykey + "/uniqueId/patients");

        saveLoad.style.display = 'block';
        noRef.once('value').then(function (data) {
          var num = (data.val() ? data.val() : 0) + 1;
          var no = self._patientsNoUpdate(num);

          var push = ref.push({
            personal: {
              email: self.email,
              firstname: self.fname,
              middlename: self.mname,
              lastname: self.lname,
              birthday: self._formatToGDate(self.bday),
              status: self.status ? self.status : "",
              sex: self.sex ? self.sex : "",
              contact: self.contact,
              address: self.address,
              occupation: self.occupation,
              employer: self.employer,
              emp_phone: self.emp_phone,
              referred: self.refer ? self.refer : "",
              doctor: self.doctor,
              hospital: self.hospital_name,
              name: self.lname + ', ' + self.fname + ' ' + self.mname,
              clinic_location: self.myLocation
            },
            insurance: {
              card: self.card,
              birthday: self._formatToGDate(self.bdate),
              address: self.in_address,
              home_phone: self.home_phone,
              primary_insurance: self.indicate,
              relationship: self.p_relation
            },
            emergency: {
              name: self.name_e,
              relationship: self.relation_e,
              home_phone: self.phone_e,
              work_phone: self.work_phone
            },
            created: today,
            no: no
          });

          if (push.key) {
            noRef.set(num);
            self.patientNo = no;
            self._reportsUpdate(today, mykey);

            if (self.profile) {
              var storageRef = firebase.storage().ref('profilePicture/' + self.profile.name);
              storageRef.put(self.profile.blob).then(function (snapshot) {
                ref.child(push.key).update({ profile: snapshot.downloadURL });
                self.downloadURL = snapshot.downloadURL;
              });
            }

            if (add2Que) {
              var queueData = {
                patient_info: {
                  firstname: self.fname,
                  middlename: self.mname,
                  lastname: self.lname,
                  birthday: self._formatToGDate(self.bday),
                  sex: self.sex ? self.sex : "",
                  name: self.lname + ', ' + self.fname + ' ' + self.mname,
                  hmo: self.indicate
                },
                patient_profile: self.downloadURL ? self.downloadURL : null,
                patient_refKey: push.key,
                patient_no: no,
                queueLocation: myLocation,
                isCancel: false,
                isQueue: true,
                isNext: true,
                queueNo: 1,
                xy: "y"
              }

              self._locateNextQueue(mykey, queueData, pickDate);
            }

            saveLoad.style.display = 'none';
            saveSucc.style.display = 'block';
          } else {
            saveLoad.style.display = 'none';
            saveErr.style.display = 'block';
          }
        });
      },

      _patientsNoUpdate(num) {
        if (num > 0 && num < 10) {
          num = '000' + num;
        }
        else if (num > 9 && num < 100) {
          num = '00' + num;
        }
        else if (num > 99 && num < 1000) {
          num = '0' + num;
        }
        else if (num > 999) {
          num = num;
        }
        else {
          num = '0000';
        }

        return num;
      },

      _reportsUpdate(today, mykey) {
        var mm = today.substring(0, 7);
        var yy = today.substring(0, 4);

        var dayRef = firebase.database().ref("/" + mykey + "/reports/daily/" + today + '/patients');
        dayRef.once('value').then(function (snapshot) {
          dayRef.set(snapshot.val() + 1);
        });

        var yearRef = firebase.database().ref("/" + mykey + "/reports/yearly/" + yy + '/patients');
        yearRef.once('value').then(function (snapshot) {
          yearRef.set(snapshot.val() + 1);
        });

        var monthRef = firebase.database().ref("/" + mykey + "/reports/monthly/" + mm + '/patients');
        monthRef.once('value').then(function (snapshot) {
          monthRef.set(snapshot.val() + 1);
        });
      },

      _locateNextQueue(mykey, queueData, pickDate) {
        var queueRef = firebase.database().ref("/" + mykey + "/queue/" + queueData.queueLocation + "/" + pickDate);
        queueRef.once('value').then(function (snapshot) {
          if (snapshot.exists()) {
            queueRef.orderByChild("isNext").equalTo(true).once('value').then(function (hasNext) {
              if (hasNext.exists()) {
                queueData.isNext = false;
                queueData.queueNo = snapshot.numChildren() + 1;
                queueRef.push(queueData);
              }
              else {
                queueData.queueNo = snapshot.numChildren() + 1;
                queueRef.push(queueData);
              }
            });
          }
          else {
            queueRef.push(queueData);
          }
        });
      },

    })
  </script>
</dom-module>