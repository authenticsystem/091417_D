<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">

<dom-module id="my-reset-password">
    <template>
        <style include="shared-styles">
            :host {
                display: block;

                padding: 10px;
            }

            @media (min-width: 767px) {
                .main-container {
                    height: 100%;
                    background-color: white;
                    max-width: 370px;
                    margin: 16px auto;
                    padding: 40px;
                    box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
                }

            }

            @media (max-width: 767px) {
                :host {
                    height: 100%;
                }
                .main-container {
                    height: 100%;
                    background-color: white;
                    margin: 0 auto;
                    padding: 40px;
                    box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
                }

            }

            .header {
                font-size: 24px;
                font-weight: 400;
            }

            .action {
                /* display: inline-block; */
                float: right;
            }

            .action paper-button {
                height: 32px;
                font-size: 12px;
                font-weight: 400;
                width: 80px;
            }

            .footer {
                height: 48px;
                /* align-items: middle; */
            }

            paper-button.green {
                background-color: var(--paper-green-500);
                color: white;
            }

            /* paper-button.green[active] {
                background-color: var(--paper-red-500);
            } */
        </style>

        <div class="main-container">

            <paper-toast id="toastResetP" text="" duration="5000"></paper-toast>

            <a style="text-decoration:none;" href="/">
                <iron-image placeholder="images/manifest/icon-512x512.png" data-src="images/manifest/icon-512x512.png" sizing="cover" preload
                    fade style="width:128px; height:128px;"></iron-image>
            </a>
            <div id="reset">
                <div class="header">Reset Password</div>
                <div>to BaseEMR</div>
                <br>
                <div id="errorMsgDiv" style="display: none;">
                    <iron-icon icon="my-icons:error-outline"></iron-icon>&nbsp;{{validationMessage}}
                </div>
                <paper-input label="Email" id="email" value="{{email}}" required auto-validate error-message=""></paper-input>
                <br>
                <div class="footer">
                    <div class="action">
                        <paper-button on-tap="_cancel">cancel</paper-button>
                        <paper-button id="next" toggles class="custom green" on-tap="_resetPasswowrd">next</paper-button>
                    </div>
                    <paper-spinner id="nextSpinner" active style="float:right; margin-right:10px; display:none"></paper-spinner>
                </div>
            </div>
            <div id="resetOk" style="display:none">
                <div>Password reset link send successfully to
                    <b>{{email}}</b>.</div>
                <br>
                <div class="footer">
                    <div class="action">
                        <paper-button toggles class="custom green" on-tap="_cancel">Ok</paper-button>
                    </div>
                </div>
            </div>
        </div>

    </template>

    <script>
        Polymer({
            is: 'my-reset-password',

            properties: {
                email: {
                    type: String,
                    observer: 'emailChanged'
                }
            },

            emailChanged() {
                Polymer.dom(this.root).querySelector("#nextSpinner").style.display = 'none';
                Polymer.dom(this.root).querySelector("#next").disabled = false;
                Polymer.dom(this.root).querySelector("#errorMsgDiv").style.display = 'none';
            },

            _resetPasswowrd() {
                var spinner = Polymer.dom(this.root).querySelector("#nextSpinner");
                var btn = Polymer.dom(this.root).querySelector("#next");
                if (!this.email) {
                    Polymer.dom(this.root).querySelector("#errorMsgDiv").style.display = 'block';
                    this.validationMessage = 'Please enter your email.';
                    btn.disabled = true;
                }
                else {
                    btn.disabled = true;
                    spinner.style.display = 'block';
                    Polymer.dom(this.root).querySelector("#errorMsgDiv").style.display = 'none';
                    var success = Polymer.dom(this.root).querySelector("#resetOk");
                    var reset = Polymer.dom(this.root).querySelector("#reset");
                    var toast = Polymer.dom(this.root).querySelector("#toastResetP");

                    var auth = firebase.auth();
                    var email = Polymer.dom(this.root).querySelector("#email");

                    auth.sendPasswordResetEmail(this.email).then(function () {
                        success.style.display = 'block';
                        reset.style.display = 'none';
                    }).catch(function (error) {
                        spinner.style.display = 'none';
                        toast.opened = true;
                        toast.text = error.message;
                    });
                }
            },

            _cancel() {
                window.location = '/signin';
            }
        })
    </script>
</dom-module>