<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="shared-styles.html">

<dom-module id="my-email-verification">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
                /* overflow: hidden; */
            }

            @media (min-width: 767px) {
                .main-container {
                    height: 100%;
                    background-color: white;
                    max-width: 370px;
                    margin: 16px auto;
                    padding: 40px;
                    box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
                }

            }

            @media (max-width: 767px) {
                :host {
                    height: 100%;
                }
                .main-container {
                    height: 100%;
                    background-color: white;
                    margin: 0 auto;
                    padding: 40px;
                    box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
                }

            }

            paper-button.green {
                background-color: var(--paper-green-500);
                color: white;
                height: 38px;

            }

            paper-button.default {
                height: 38px;
            }

            .action {
                /* display: inline-block; */
                float: right;
            }

            .footer {
                height: 48px;
                /* align-items: middle; */
            }

            .header {
                font-size: 18px;
                font-weight: bold;
            }

            .action paper-button {
                height: 32px;
                font-size: 12px;
                font-weight: 400;
                width: 80px;
            }

            #errorMsgDiv1 {
                margin-bottom: 15px;
                padding: 6px 12px;
                font-size: 14px;
                background-color: #ffdddd;
                border-left: 6px solid #f44336;
            }

            .moreoption {
                float: left;
            }
        </style>

        <firebase-auth id="auth" user="{{user}}" provider="google" on-error="handleError"></firebase-auth>

        <div class="main-container">

            <paper-toast id="toastResend" text="Email verification resend." duration="3000"></paper-toast>

            <a style="text-decoration:none;" href="/">
                <iron-image placeholder="images/manifest/icon-512x512.png" data-src="images/manifest/icon-512x512.png" sizing="cover" preload
                    fade style="width:128px; height:128px;"></iron-image>
            </a>
            </br>
            <div>
                <div id="emailV">
                    <div class="header">Email not yet verify</div>
                    <span>Let us know if this email belongs to you. Click the link in the email sent to
                        <b>{{user.email}}</b>.
                    </span>
                    </br>
                    </br>
                    <div class="footer">
                        <!-- <paper-button style="text-transform:capitalize; color:rgb(4, 4, 143); font-size:13px; padding:0" href="" on-tap="_showDiv2">Sign out</paper-button> -->
                        <!-- <paper-button style="text-transform:capitalize; color:rgb(4, 4, 143); font-size:13px; padding:0" href="" on-tap="_showDiv2">Change email?</paper-button> -->
                        <div class="moreoption">
                            <paper-menu-button>
                                <div slot="dropdown-trigger" style="color: royalblue; font-size:15px;">More options</div>
                                <paper-listbox slot="dropdown-content">
                                    <paper-item>
                                        <a style="text-decoration:none;" href="#" on-tap="_showDiv2">Change email?</a>
                                    </paper-item>
                                    <paper-item>
                                        <a style="text-decoration:none;" href="#" on-tap="_signOut">Sign out</a>
                                    </paper-item>
                                </paper-listbox>
                            </paper-menu-button>
                        </div>
                        <div class="action">
                            <paper-button class="default" on-tap="_resend" raised>resend</paper-button>
                            <paper-button class="green" on-tap="_reload">next</paper-button>
                        </div>
                    </div>
                </div>

                <div id="emailC" style="display:none;">
                    <div class="header">
                        <span style="font-weight:400">Change email</span> {{user.email}}</div>
                    <div id="errorMsgDiv" style="display: none;">
                        <iron-icon icon="my-icons:error-outline"></iron-icon>&nbsp;{{validationMessage}}</div>
                    <paper-input label="New email address" always-float-label id="email" value="{{email}}"></paper-input>
                    </br>
                    <div class="footer">
                        <div class="action">
                            <paper-button class="default" on-tap="_reload">cancel</paper-button>
                            <paper-button id="next" class="green" on-tap="_changeEmail">next</paper-button>
                            <!-- <paper-button class="green" on-tap="_registerAccount">next</paper-button> -->
                        </div>
                    </div>
                </div>

                <div id="reAuth" style="display:none;">
                    <div class="header">Re-authentication required
                        <br>
                        <span style="font-size:14px; font-weight:400;">Please enter your email and password to continue.
                        </span>
                    </div>
                    <div id="errorMsgDiv1" style="display:none">
                        <iron-icon icon="my-icons:error-outline"></iron-icon>&nbsp;{{validationMessage}}</div>
                    <paper-input label="Email" value="{{oldEmail}}" always-float-label required auto-validate error-message=""></paper-input>
                    <paper-input label="Password" type="password" value="{{password}}" always-float-label required auto-validate error-message=""></paper-input>
                    </br>
                    <div class="footer">
                        <div class="action">
                            <paper-button class="default" on-tap="_reload">cancel</paper-button>
                            <paper-button id="next1" class="green" on-tap="_reChangeEmail">next</paper-button>
                            <!-- <paper-button class="green" on-tap="_registerAccount">next</paper-button> -->
                        </div>
                        <!-- <paper-spinner active style="float:right; margin-right:10px;"></paper-spinner> -->
                        <paper-spinner id="spinnerNext1" active style="float:right; margin-right:10px;"></paper-spinner>
                    </div>
                </div>
            </div>

        </div>


    </template>

    <script>
        Polymer({
            is: 'my-email-verification',

            observers: [
                '_inputChanged(email,oldEmail,password)'
            ],

            _inputChanged(email, oldemail, password) {
                Polymer.dom(this.root).querySelector("#errorMsgDiv").style.display = 'none';
                Polymer.dom(this.root).querySelector("#errorMsgDiv1").style.display = 'none';
                Polymer.dom(this.root).querySelector("#next").disabled = false;
                Polymer.dom(this.root).querySelector("#next1").disabled = false;
                Polymer.dom(this.root).querySelector("#spinnerNext1").style.display = "none";
            },

            handleError() {
                Polymer.dom(this.root).querySelector("#errorMsgDiv").style.display = 'block';
                this.validationMessage = 'Invalid email or password.';
                Polymer.dom(this.root).querySelector("#next1").disabled = true;
            },

            _signOut() {
                this.$.auth.signOut();
                window.location.reload();
            },

            _reload() {
                window.location.reload();
            },

            _resend() {
                var toast = Polymer.dom(this.root).querySelector("#toastResend");
                var user = firebase.auth().currentUser;
                user.sendEmailVerification().then(function () {
                    toast.opened = true;
                });
            },

            _showDiv2() {
                Polymer.dom(this.root).querySelector("#emailV").setAttribute("style", "display: none");
                Polymer.dom(this.root).querySelector("#emailC").setAttribute("style", "display: block");
                Polymer.dom(this.root).querySelector("#reAuth").style.display = 'none';
            },

            _reChangeEmail() {
                if (!this.oldEmail) {
                    Polymer.dom(this.root).querySelector("#errorMsgDiv1").style.display = 'block';
                    this.validationMessage = 'Please enter your email.';
                    Polymer.dom(this.root).querySelector("#next1").disabled = true;
                }
                else if (!this.password) {
                    Polymer.dom(this.root).querySelector("#errorMsgDiv1").style.display = 'block';
                    this.validationMessage = 'Please enter your password.';
                    Polymer.dom(this.root).querySelector("#next1").disabled = true;
                }
                else {
                    var spinner = Polymer.dom(this.root).querySelector("#spinnerNext1");
                    var newEmail = this.email;
                    var err = Polymer.dom(this.root).querySelector("#errorMsgDiv1");
                    err.style.display = 'none';
                    spinner.style.display = 'block';
                    this.validationMessage = 'The email address is already in use by another account.';

                    this.$.auth.signInWithEmailAndPassword(this.oldEmail, this.password)
                        .then(function (user) {
                            err.style.display = 'none';
                            user.updateEmail(newEmail)
                                .then(function () {
                                    spinner.style.display = 'none';
                                    window.location.reload();
                                })
                                .catch((error) => {
                                    spinner.style.display = 'none';
                                    err.style.display = 'block';
                                });
                        })
                        .catch(function (error) {
                            err.style.display = 'block';
                            spinner.style.display = 'none';
                        });
                }
            },

            _changeEmail() {
                // here 1am
                if (!this.email) {
                    Polymer.dom(this.root).querySelector("#errorMsgDiv").style.display = 'block';
                    this.validationMessage = 'Please enter your email address.';
                    Polymer.dom(this.root).querySelector("#next").disabled = true;
                }
                else {
                    var atpos = this.email.indexOf("@");
                    var dotpos = this.email.lastIndexOf(".");

                    if (atpos < 1 || dotpos < atpos + 2 || dotpos + 2 >= this.email.length) {
                        Polymer.dom(this.root).querySelector("#errorMsgDiv").style.display = 'block';
                        this.validationMessage = 'Invalid email address.';
                        Polymer.dom(this.root).querySelector("#next").disabled = true;
                    }
                    else {
                        Polymer.dom(this.root).querySelector("#errorMsgDiv").style.display = 'none';
                        this.validationMessage = '';
                        Polymer.dom(this.root).querySelector("#reAuth").style.display = 'block';
                        Polymer.dom(this.root).querySelector("#emailC").setAttribute("style", "display: none");
                        Polymer.dom(this.root).querySelector("#emailV").setAttribute("style", "display: none");
                        // this.user.updateEmail(this.email);
                    }
                }
            }
        })

    </script>
</dom-module>