<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="bwt-datatable-card.html">
<link rel="import" href="my-secretary-new.html">
<link rel="import" href="my-secretary-edit.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="my-icons.html">

<dom-module id="my-secretary">
    <template>
        <style include="shared-styles">
            :host {
                display: block;

                padding: 10px;
            }

            app-header {
                color: rgb(255, 255, 255);
                background-color: #673AB7;
            }

            paper-icon-button.menu {
                margin-right: 16px;
            }

            paper-fab.fab-menu {
                position: fixed;
                bottom: 32px;
                right: 32px;
            }

            paper-button {
                height: 32px;
                font-size: 12px;
                font-weight: 400;
                width: 80px;
            }

            paper-icon-button {
                color: rgb(233, 79, 164);
            }
        </style>

        <app-location route='{{route}}' use-hash-as-path></app-location>
        <app-route route='{{route}}' pattern='/new' data='{{newData}}' active="{{newSecretary}}"></app-route>
        <app-route route='{{route}}' pattern='/edit/:key' data='{{editData}}' active="{{editSecretary}}"></app-route>

        <template is="dom-if" if="{{secretaryActive}}" restamp="true">
            <app-drawer-layout fullbleed>
                <app-header-layout has-scrolling-region>
                    <app-header fixed slot="header">
                        <app-toolbar primary>
                            <a href="/settings">
                                <paper-icon-button style="color:white" class="menu" icon="my-icons:arrow-back"></paper-icon-button>
                            </a>
                            <div main-title>My Secretary</div>
                        </app-toolbar>
                    </app-header>

                    <firebase-query path="/{{myKey}}/secretary" data="{{account}}"></firebase-query>

                    <paper-datatable-card style="padding:17px;" header-fixed id-property="$key" header="Secretary" id="datatableCard">
                        <div slot="toolbar-select">
                            <paper-icon-button id="delete" icon="my-icons:delete-forever" no-ink on-tap="_deleteSelected"></paper-icon-button>
                            <paper-tooltip for="delete" position="bottom">Delete</paper-tooltip>
                        </div>

                        <div slot="toolbar-select-single">
                            <!-- <paper-icon-button alt="{{keyS}}" id="edit" icon="datatable:editable" no-ink on-tap="_editSecretary"></paper-icon-button> -->
                            <paper-icon-button hidden="{{block}}" id="activate" icon="my-icons:assignment-turned-in" no-ink on-tap="_activateSelected"></paper-icon-button>
                            <paper-icon-button hidden="{{!block}}" id="deactivate" icon="my-icons:block" no-ink on-tap="_deactivateSelected"></paper-icon-button>

                            <paper-tooltip for="edit" position="bottom">Edit</paper-tooltip>
                            <paper-tooltip for="activate" position="bottom">Activate</paper-tooltip>
                            <paper-tooltip for="deactivate" position="bottom">Deactivate</paper-tooltip>
                        </div>

                        <paper-datatable data="{{account}}" id="datatable" header-fixed multi-selection selectable selected-items="{{selectedItem}}">
                            <paper-datatable-column header="Account Code" type="String" property="code"></paper-datatable-column>
                            <paper-datatable-column header="Name" type="Object" property="name">
                                <template>
                                    <span>[[value.firstname]]</span>
                                    <span>[[value.middlename]]</span>
                                    <span>[[value.lastname]]</span>
                                    <span>[[value.suffix]]</span>
                                </template>
                            </paper-datatable-column>
                            <paper-datatable-column header="Cellphone" type="String" property="cellphone"></paper-datatable-column>
                            <paper-datatable-column header="Active" type="Boolean" property="active"></paper-datatable-column>
                        </paper-datatable>
                    </paper-datatable-card>

                </app-header-layout>

                <paper-fab id="fab" noink class="fab-menu" on-tap="_addSecretary" icon="my-icons:add"></paper-fab>
            </app-drawer-layout>
        </template>

        <template is="dom-if" if="{{newSecretary}}" restamp="true">
            <my-secretary-new my-key="{{myKey}}" my-lastname="{{myLastname}}"></my-secretary-new>
        </template>

        <div hidden$="{{!editSecretary}}">
            <my-secretary-edit></my-secretary-edit>
        </div>

        <paper-dialog id="deleteAccount">
            <h3>Delete this secretary permanently?</h3>
            <div class="buttons">
                <paper-button style="background:rgb(207, 206, 206);color:black" dialog-dismiss autofocus>No</paper-button>
                <paper-button style="background:rgb(207, 206, 206);" dialog-confirm on-tap="delete">Yes</paper-button>
            </div>
        </paper-dialog>

        <paper-dialog id="deactivateAccount">
            <h3>Deactivate this secretary?</h3>
            <div class="buttons">
                <paper-button style="background:rgb(207, 206, 206);color:black" dialog-dismiss autofocus>No</paper-button>
                <paper-button style="background:rgb(207, 206, 206);" dialog-confirm on-tap="deactivate">Yes</paper-button>
            </div>
        </paper-dialog>

        <paper-dialog id="activateAccount">
            <h3>Activate this secretary?</h3>
            <div class="buttons">
                <paper-button style="background:rgb(207, 206, 206);color:black" dialog-dismiss autofocus>No</paper-button>
                <paper-button style="background:rgb(207, 206, 206);" dialog-confirm on-tap="activate">Yes</paper-button>
            </div>
        </paper-dialog>

    </template>

    <script>
        class MySecretary extends Polymer.Element {
            static get is() { return 'my-secretary'; }

            static get properties() {
                return {
                    user: Object,
                    myKey: String,
                    myLastname: String,
                    newSecretary: Boolean,
                    editSecretary: Boolean,
                    selectedItems: Object,
                    secretaryActive: {
                        type: Boolean,
                        value: true,
                        notify: true
                    },
                    selectedItem: {
                        type: String,
                        observer: '_selectedItemChanged'
                    },
                    keyS: {
                        type: String,
                        value: ''
                    },
                    block: {
                        type: Boolean,
                        value: true
                    }
                };
            }

            static get observers() {
                return [
                    '_changeRoute(newSecretary,editSecretary)',
                ];
            }

            _changeRoute(e, f) {
                if (e || f) {
                    this.secretaryActive = false;
                }
                else {
                    this.secretaryActive = true;
                }
            }

            _addSecretary() {
                window.location.hash = '/new';
            }

            _editSecretary(e) {
                var data_args = Polymer.dom(e).rootTarget.getAttribute("alt");
                window.location.hash = '/edit/' + data_args;
            }

            _selectedItemChanged() {
                if (this.selectedItem.length > 0) {
                    if (this.selectedItem.length > 1) {
                        this.selectedItems = this.selectedItem;
                        // for (var i = 0; i < this.selectedItem.length; ++i) {
                        //   console.log(this.selectedItem[i].$key);
                        // }
                    }
                    else {
                        this.keyS = this.selectedItem[0].$key;
                        this.selectedItems = this.selectedItem;

                        if (this.selectedItem[0].active == false) {
                            this.block = false;
                        }
                        else {
                            this.block = true;
                        }
                    }
                }
            }

            _activateSelected() {
                this.$.activateAccount.open();
            }

            _deactivateSelected() {
                this.$.deactivateAccount.open();
            }

            _deleteSelected() {
                this.$.deleteAccount.open();
            }

            activate() {
                if (this.selectedItems.length > 0) {
                    var ref = firebase.database().ref('/' + this.myKey + '/secretary');
                    for (var i = 0; i < this.selectedItems.length; ++i) {
                        ref.child(this.selectedItems[i].$key).update({ active: true });
                    }
                    Polymer.dom(this.root).querySelector("#datatable")._queryAndSetColumns();
                    Polymer.dom(this.root).querySelector("#datatable").deselectAll();
                }
            }

            deactivate() {
                if (this.selectedItems.length > 0) {
                    var ref = firebase.database().ref('/' + this.myKey + '/secretary');
                    for (var i = 0; i < this.selectedItems.length; ++i) {
                        ref.child(this.selectedItems[i].$key).update({ active: false });
                    }
                    Polymer.dom(this.root).querySelector("#datatable")._queryAndSetColumns();
                    Polymer.dom(this.root).querySelector("#datatable").deselectAll();
                }
            }

            delete() {
                if (this.selectedItems.length > 0) {
                    var ref = firebase.database().ref('/' + this.myKey + '/secretary');
                    for (var i = 0; i < this.selectedItems.length; ++i) {
                        ref.child(this.selectedItems[i].$key).remove();
                    }
                    Polymer.dom(this.root).querySelector("#datatable").deselectAll();
                }
            }

        }

        window.customElements.define(MySecretary.is, MySecretary);
    </script>
</dom-module>