<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/paper-avatar/paper-avatar.html">
<link rel="import" href="../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../bower_components/vaadin-notification/vaadin-notification.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="my-icons.html">

<dom-module id="my-messaging-secretary">
    <template>
        <style include="shared-styles">
            :host {
                height: 100vh;
                margin: 0;
                display: flex;
                flex-direction: column;
            }

            @media (max-width: 768px) {
                .textArea {
                    width: 85%;
                    margin-top: -16px;
                    margin-bottom: 3px;
                }

                .footer {
                    width: 96.7%;
                }
            }

            @media (min-width: 768px) {
                .textArea {
                    width: 95%;
                    margin-top: -16px;
                    margin-bottom: 3px;
                }

                .footer {
                    width: 98.6%;
                }

            }

            app-header {
                color: rgb(255, 255, 255);
                background-color: #673AB7;
            }

            paper-icon-button.menu {
                margin-right: 16px;
            }

            app-drawer {
                --app-drawer-content-container: {
                    background-color: #F4F5F6;
                }
            }

            paper-item {
                height: 64px;
                border: 1px solid rgb(135, 177, 219);
                margin-bottom: 6px;
            }

            paper-item:hover {
                background: rgba(104, 58, 183, 0.26);
                cursor: pointer;
            }

            app-drawer-layout:not([narrow]) [drawer-toggle] {
                display: none;
            }

            .mnu {
                padding: 13px;
                overflow: auto;
                height: 96%;
            }

            .footer {
                position: absolute;
                bottom: 0;
                overflow: hidden;
                background-color: white;
                color: black;
                padding: 6px;
                box-shadow: 3px 3px 50px 1px rgb(155, 155, 155);
                @apply --layout-horizontal;
            }

            .messageHolder {
                padding: 16px;
                overflow: auto;
                height: 82%;
            }

            .me {
                padding: 10px;
                font-size: 14px;
                background: white;
                border-radius: 6px;
                margin-top: 6px;
                /* width: 50%; */
                float: right;
                clear: both;
            }

            .you {
                padding: 10px;
                font-size: 14px;
                background: white;
                border-radius: 6px;
                margin-top: 6px;
                float: left;
                clear: both;
                /* width: 50%; */
            }

            .small {
                --paper-avatar-width: 30px;
            }

            .badge {
                padding: 3px;
                border: .5px solid rgb(199, 199, 199);
                font-size: 12px;
                font-weight: 400;
                height: 20px;
                position: absolute;
                right: 10px;
            }
        </style>

        <firebase-query id="query" path="/{{myKey}}/doctors" data="{{myDoctors}}"></firebase-query>

        <app-drawer-layout fullbleed narrow="{{narrow}}" id="drawerLayout">
            <app-drawer id="drawer" slot="drawer" swipe-open="[[narrow]]" align="right">
                <paper-listbox class="mnu" selected="{{selectedContact}}" attr-for-selected="name">
                    <template is="dom-repeat" items="[[myDoctors]]">
                        <paper-item name="[[item.code]]">
                            <paper-avatar class="small" label="[[item.lastname]]"></paper-avatar>
                            <div style="margin-left:6px; font-size: 14px;">Dr. [[item.lastname]]</div>
                            <div hidden$="{{!item.msg}}" class="badge">{{_msg(item.msg)}}</div>
                        </paper-item>
                    </template>
                </paper-listbox>
            </app-drawer>

            <app-header-layout fullbleed has-scrolling-region>
                <app-header fixed slot="header">
                    <app-toolbar primary>
                        <paper-icon-button class="menu" icon="my-icons:menu" on-tap="toggleDrawer"></paper-icon-button>
                        <div main-title>Messaging</div>
                        <paper-icon-button class="menu" icon="my-icons:contacts" drawer-toggle></paper-icon-button>
                    </app-toolbar>
                </app-header>

                <firebase-query id="query" path="/{{myKey}}/messages/{{selectedContact}}" data="{{myMessages}}"></firebase-query>

                <div class="messageHolder" id="messageHolder">

                    <template is="dom-repeat" items="[[myMessages]]">
                        <div class$="[[_getClass(item.sender)]]">
                            [[item.message]]
                            <div style="color:gray; font-size:12px">
                                <span style$="[[_getStyle(item.sender)]]">[[_getTime(item.time)]]</span>
                            </div>
                        </div>
                    </template>

                </div>
                <div class="footer">
                    <paper-textarea id="msgValue" class="textArea" value="{{msg}}" placeholder="Message .."></paper-textarea>
                    <paper-icon-button id="sendBtn" on-tap="_sendMsg" icon="my-icons:send"></paper-icon-button>
                    <!-- <iron-a11y-keys target="[[targetLocation]]" keys="enter" on-keys-pressed="onEnter"></iron-a11y-keys> -->
                </div>

            </app-header-layout>
        </app-drawer-layout>

        <vaadin-notification id="V_notification" duration="0" position="bottom-end">
            <template>
                <div style="padding: 6px;">
                    <b>Notice</b>
                    <br> You have a new message.
                </div>
                <paper-icon-button icon="my-icons:close" title="Close" on-tap="closeV_notification"></paper-icon-button>
            </template>
        </vaadin-notification>

        <audio src="../dist/notification.mp3" id="audio">

    </template>
    <script>
        Polymer({
            is: 'my-messaging-secretary',
            properties: {
                myKey: String,
                myRole: String,
                myLocation: String,
                myLocationCode: String,
                route: Object,
                token: String,
                narrow: {
                    type: Boolean,
                    notify: true
                },
                lastSelectedContact: String,
                NoOfMsg: {
                    type: Number,
                    value: 0,
                    notify: true
                }
            },

            observers: [
                '_myDoctorsChanged(myDoctors)',
                '_msgChanged(msg)',
                '_selectedContactChanged(selectedContact)',
                '_myMessagesChanged(myMessages.*)',
                '_NoOfMsgChanged(NoOfMsg)'
            ],

            ready() {
                this.$.sendBtn.disabled = true;
                this.targetLocation = this.$.msgValue;
                setTimeout((e) => {
                    this.$.messageHolder.scrollTop = this.$.messageHolder.scrollHeight;
                }, 1000);
            },

            _NoOfMsgChanged(e) {
                var lastNoOfMsg = 0;
                if (e > lastNoOfMsg) {
                    lastNoOfMsg = e;
                    this.$.audio.play();
                    if (this.token) {
                        this._handleSend(this.token);
                    }
                    if (this.route.prefix !== "/messaging") {
                        this.$.V_notification.open();
                    }
                }
            },

            _myMessagesChanged() {
                if (this.myMessages.length > 0) {
                    var data = [];
                    var num = 0;

                    this.myMessages.forEach(element => {
                        if (element.sender !== this.myKey) {
                            data.push(element.sender);
                            if (data.length > 0) {
                                if (data.length > num) {
                                    num = data.length;
                                }
                            }
                        }
                    });
                    this.NoOfMsg = num;
                }
            },

            _selectedContactChanged(e) {
                this.NoOfMsg = 0;
                this._msgReset(e);
            },

            _msgChanged(e) {
                if (e) {
                    this.$.sendBtn.disabled = false;
                }
                else {
                    this.$.sendBtn.disabled = true;
                }
            },

            _myDoctorsChanged() {
                if (this.myDoctors.length > 0) {
                    this.selectedContact = this.myDoctors[0].code;
                    this.lastSelectedContact = this.myDoctors[0].code;
                }
            },

            _sendMsg() {
                this._msgReset(this.selectedContact);
                if (this.msg) {
                    if (this.selectedContact) {
                        var push = firebase.database().ref("/" + this.myKey + "/messages/" + this.selectedContact)
                            .push({
                                time: firebase.database.ServerValue.TIMESTAMP,
                                message: this.msg,
                                sender: this.myKey
                            });
                        if (push.key) {
                            var ref = firebase.database().ref("/" + this.selectedContact + "/secretary");
                            ref.orderByChild("code").equalTo(this.myKey).once("value").then(function (data) {
                                if (data.exists()) {
                                    if (Object.values(data.val())[0].msg) {
                                        ref.child(Object.keys(data.val())[0]).update({ msg: Object.values(data.val())[0].msg + 1 });
                                    }
                                    else {
                                        ref.child(Object.keys(data.val())[0]).update({ msg: 1 });
                                    }
                                }
                            });
                            this.msg = '';
                        }
                    }
                }
            },

            // onEnter() {
            //     this._sendMsg();
            // },

            _msgReset(e) {
                var ref = firebase.database().ref("/" + this.myKey + "/doctors");
                ref.orderByChild("code").equalTo(e).once("value").then(function (data) {
                    if (data.exists()) {
                        if (Object.values(data.val())[0].msg) {
                            ref.child(Object.keys(data.val())[0]).update({ msg: "" });
                        }
                    }
                });
            },

            _handleSend(token) {
                //live
                // var key = 'AAAAQ8LD1Cg:APA91bGRSq9El2u5pGd1PsU7b9wwqtq3SNIr6LMXKE344xq7b3fv7_DTaZQNb6-DgSQfkWf5ZAkYF2qD_i_78DwW-24y9hcZlqeQ9xlfP1xmxVTrs3V-bQfkEIYPwqgnIp3tjR6M2Ubu';
                //dev
                var key = 'AAAAevULLrY:APA91bEDdvrl9xFBHsKwRPmiTvBfMx_5TwGR1rhMstS9v6RD_TZC-BHiHMMx_5KKtBPHLXvUQH92M2Bu-CT2Mko-mLaQ0mpjl2wjbadZzk90oi3KmiH_7SChuBtHPTkWQLZUp4tlAZjV';
                var to = token;
                var notification = {
                    'title': 'BaseEMR',
                    'body': 'You have a new message.',
                    'icon': '../images/icon.png',
                    // 'click_action': 'https://pwa.baseph.com/messaging'
                    'click_action': ' https://emr-dev-c3005.firebaseapp.com/messaging'
                    // 'click_action': 'localhost:8081/messaging'
                };

                fetch('https://fcm.googleapis.com/fcm/send', {
                    'method': 'POST',
                    'headers': {
                        'Authorization': 'key=' + key,
                        'Content-Type': 'application/json'
                    },
                    'body': JSON.stringify({
                        'notification': notification,
                        'to': to
                    })
                }).then(function (response) {
                    // console.log(response);
                }).catch(function (error) {
                    console.warn(error);
                });
            },

            _msg(e) {
                if (e) {
                    if (e > 9) {
                        return e.toString().slice(0, 1) + ".";
                    }
                    else {
                        return e;
                    }
                }
            },

            _getClass(e) {
                if (e === this.myKey) return 'me';
                else return 'you';
            },

            _getStyle(e) {
                if (e === this.myKey) return 'float: left;';
                else return 'float: right;';
            },

            _getTime(e) {
                var date = new Date(e);
                return date.getHours() + ":" + date.getMinutes();
            },

            closeV_notification() {
                this.$.V_notification.close();
            },

            toggleDrawer() {
                this.dispatchEvent(new CustomEvent('toggleDrawer', {
                    bubbles: true, composed: true, detail: {
                        narrow: this.$.narrow
                    }
                }));
                this.$.narrow = !this.$.narrow;
            }

        })
    </script>
</dom-module>