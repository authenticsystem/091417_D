<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/paper-avatar/paper-avatar.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">

<link rel="import" href="global-functions.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="my-icons.html">

<dom-module id="my-messaging-secretary">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
            }

            app-header {
                color: rgb(255, 255, 255);
                background-color: #673AB7;
            }

            paper-icon-button.menu {
                margin-right: 16px;
            }

            app-drawer {
                --app-drawer-content-container: {
                    background-color: #F4F5F6;
                }
            }

            paper-icon-item {
                padding: 8px;
                -webkit-box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23);
                -moz-box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23);
                box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23);
                border-bottom: 0;
                margin-bottom: 6px;
                transition: 0.3s;
            }

            paper-icon-item:hover {
                background: rgba(104, 58, 183, 0.26);
                cursor: pointer;
            }

            app-drawer-layout:not([narrow]) [drawer-toggle] {
                display: none;
            }

            p {
                white-space: pre;
            }
        </style>

        <firebase-query path="/{{myKey}}/doctors" data="{{myDoctors}}"></firebase-query>
        <firebase-query path="/{{myKey}}/messages/{{selectedContactCode}}" data="{{myMessages}}" limit-to-last="15"></firebase-query>

        <app-drawer-layout fullbleed narrow="{{narrow}}" id="drawerLayout">
            <app-drawer id="drawer" slot="drawer" swipe-open="[[narrow]]" align="right">
                <div class="item-header">
                    <b>My Contact's</b>
                </div>
                <paper-listbox class="mnu" selected="{{selectedContact}}" attr-for-selected="name">
                    <template is="dom-repeat" items="[[myDoctors]]">
                        <paper-icon-item style="text-align:left;" name="[[item.code]]~[[item.lastname]]">
                            <paper-avatar label="[[item.lastname]]" slot="item-icon"></paper-avatar>
                            <paper-item-body two-line>
                                <div class="primary">Dr. [[item.lastname]]</div>
                                <div secondary class="longText">[[_msg(item.lastMsg)]]</div>
                            </paper-item-body>
                        </paper-icon-item>
                    </template>
                </paper-listbox>
            </app-drawer>

            <app-header-layout fullbleed has-scrolling-region>
                <app-header fixed slot="header">
                    <app-toolbar primary>
                        <paper-icon-button class="menu" icon="my-icons:menu" on-tap="toggleDrawer"></paper-icon-button>
                        <div main-title>Messaging</div>
                        <paper-icon-button class="menu" icon="my-icons:contacts" drawer-toggle></paper-icon-button>
                    </app-toolbar>
                </app-header>

                <div class="content" id="messageHolder">
                    <template is="dom-repeat" items="[[myMessages]]">
                        <template is="dom-if" if="{{_ifIncomingMsg(item.sender)}}">
                            <div class="incoming_msg">
                                <paper-avatar label="[[selectedContactName]]" class="incoming_msg_img"></paper-avatar>
                                <div class="received_msg">
                                    <div class="received_withd_msg">
                                        <p>[[item.message]]</p>
                                        <span class="time_date">[[_chatTimeAndDate(item.time)]]</span>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <template is="dom-if" if="{{_ifOutgoingMsg(item.sender)}}">
                            <div class="outgoing_msg">
                                <div class="sent_msg">
                                    <p>[[item.message]]</p>
                                    <span class="time_date">[[_chatTimeAndDate(item.time)]]</span>
                                </div>
                            </div>
                        </template>

                    </template>
                </div>

                <footer>
                    <div style="display: flex;">
                        <paper-icon-button noink class$="{{_checkCollapseActive(emojiOpen)}}" on-tap="_showEmoji" icon="my-icons:insert-emoticon"></paper-icon-button>
                        <paper-textarea id="msgValue" max-rows="2" on-keypress="_onKeypressTextarea" class="textarea"
                            value="{{msg}}" placeholder="Type a message..." focused="{{textareIsFocus}}"></paper-textarea>
                        <paper-icon-button noink id="sendBtn" on-tap="_sendMsg" icon="my-icons:send"></paper-icon-button>
                    </div>
                    <iron-collapse id="collapse" opened="{{emojiOpen}}">
                        <div style="margin: 0 6px 6px 6px; cursor: default;">
                            <template id="emojiList" is="dom-repeat" items="[[emojiItems]]">
                                <span on-tap="_selectEmoji" class="emoji">[[item]]</span>
                            </template>
                        </div>
                    </iron-collapse>
                </footer>

            </app-header-layout>
        </app-drawer-layout>

        <!-- <vaadin-notification id="V_notification" duration="0" position="bottom-end">
            <template>
                <div style="padding: 6px;">
                    <b>Notice</b>
                    <br> You have a new message.
                </div>
                <paper-icon-button icon="my-icons:close" title="Close" on-tap="closeV_notification"></paper-icon-button>
            </template>
        </vaadin-notification> -->

        <!-- <audio src="../dist/notification.mp3" id="audio"> -->

    </template>
    <script>
        Polymer({
            is: 'my-messaging-secretary',
            properties: {
                myKey: String,
                myRole: String,
                myLocation: String,
                myLocationCode: String,
                route: Object,
                token: String,
                narrow: {
                    type: Boolean,
                    notify: true
                },
                emojiItems: {
                    type: Array,
                    value: function () {
                        return ['😊', '😀', '😁', '😂', '😄', '😉', '😅', '😎', '😍', '😘', '🤔', '😏', '😐', '😪', '😫', '😜', '😝', '😲', '☹️', '🙁', '😢', '😱', '😠', '😡', '😈', '👌', '👍', '🖕', '👎', '✍️', '❤️', '💔', '💤'];
                    }
                }
            },

            observers: [
                '_myDoctorsChanged(myDoctors)',
                '_msgChanged(msg)',
                '_selectedContactChanged(selectedContact)',
                '_myMessagesChanged(myMessages.splices)',
                '_textareIsFocusChanged(textareIsFocus)'
            ],

            ready() {
                this.$.sendBtn.disabled = true;
            },

            _myDoctorsChanged() {
                if (this.myDoctors.length > 0) {
                    this.selectedContact = this.myDoctors[0].code + '~' + this.myDoctors[0].lastname;
                }
            },

            _msgChanged(e) {
                if (e) this.$.sendBtn.disabled = false;
                else this.$.sendBtn.disabled = true;
            },

            _selectedContactChanged(e) {
                var [selectedContactCode, selectedContactName] = e.split('~');
                this.selectedContactCode = selectedContactCode;
                this.selectedContactName = selectedContactName;
                this._msgReset(selectedContactCode);
            },

            _onKeypressTextarea(e) {
                if (e.which == 13 && !e.shiftKey) {
                    this._sendMsg();
                    e.preventDefault();
                }
            },

            _textareIsFocusChanged(e) {
                if (e) {
                    this._msgReset(this.selectedContactCode);
                }
            },

            _sendMsg() {
                if (this.msg && this.selectedContact) {
                    var msg = this.msg;
                    var push = firebase.database().ref("/" + this.myKey + "/messages/" + this.selectedContactCode)
                        .push({
                            time: firebase.database.ServerValue.TIMESTAMP,
                            message: msg,
                            sender: this.myKey,
                            sender_name: this.selectedContactName
                        });

                    if (push.key) {
                        var ref = firebase.database().ref("/" + this.selectedContactCode + "/secretary");
                        ref.orderByChild("code").equalTo(this.myKey).once("value").then(function (data) {
                            if (data.exists()) {
                                var noOfMsg = (Object.values(data.val())[0].msg ? Object.values(data.val())[0].msg : 0) + 1;
                                ref.child(Object.keys(data.val())[0]).update({ msg: noOfMsg, lastMsg: msg });
                            }
                        });
                        this.msg = '';
                    }
                }
            },

            _myMessagesChanged() {
                if (this.myMessages.length > 0) {
                    setTimeout((e) => {
                        smooth_scroll_to(this.$.messageHolder, this.$.messageHolder.scrollHeight - this.$.messageHolder.clientHeight, 100);
                    }, 300);
                }
            },

            _showEmoji() {
                this.$.collapse.toggle();
            },

            _checkCollapseActive(e) {
                if (e) return 'emoticon_active';
                else return 'emoticon_not_active';
            },

            _selectEmoji(e) {
                var selectedImoji = this.$.emojiList.itemForElement(e.target);
                var msg = this.msg ? this.msg : '';
                this.msg = msg + selectedImoji;
                this.$.msgValue.focus();
            },

            _handleSend(token) {
                //live
                // var key = 'AAAAQ8LD1Cg:APA91bGRSq9El2u5pGd1PsU7b9wwqtq3SNIr6LMXKE344xq7b3fv7_DTaZQNb6-DgSQfkWf5ZAkYF2qD_i_78DwW-24y9hcZlqeQ9xlfP1xmxVTrs3V-bQfkEIYPwqgnIp3tjR6M2Ubu';
                //dev
                var key = 'AAAAevULLrY:APA91bEDdvrl9xFBHsKwRPmiTvBfMx_5TwGR1rhMstS9v6RD_TZC-BHiHMMx_5KKtBPHLXvUQH92M2Bu-CT2Mko-mLaQ0mpjl2wjbadZzk90oi3KmiH_7SChuBtHPTkWQLZUp4tlAZjV';
                var to = token;
                var notification = {
                    'title': 'BaseEMR',
                    'body': 'You have a new message.',
                    'icon': '../images/icon.png',
                    'tag': 'message',
                    'sound': 'default',
                    'click_action': 'https://pwa.baseph.com/messaging'
                    // 'click_action': ' https://emr-dev-c3005.firebaseapp.com/messaging'
                    // 'click_action': 'localhost:8081/messaging'
                };

                fetch('https://fcm.googleapis.com/fcm/send', {
                    'method': 'POST',
                    'headers': {
                        'Authorization': 'key=' + key,
                        'Content-Type': 'application/json'
                    },
                    'body': JSON.stringify({
                        'notification': notification,
                        'to': to
                    })
                }).then(function (response) {
                    // console.log(response);
                }).catch(function (error) {
                    console.warn(error);
                });
            },

            _chatTimeAndDate(e) {
                var date = new Date(e);
                return chatTimeAndDate(date);
            },

            _msg(e) {
                if (e) {
                    if (e.length > 26) return e.toString().slice(0, 26) + "...";
                    else return e;
                }
            },

            _msgReset(e) {
                var ref = firebase.database().ref("/" + this.myKey + "/doctors");
                ref.orderByChild("code").equalTo(e).once("value").then(function (data) {
                    if (data.exists()) {
                        if (Object.values(data.val())[0].msg) {
                            ref.child(Object.keys(data.val())[0]).update({ msg: null, lastMsg: null });
                        }
                    }
                });
            },

            closeV_notification() {
                this.$.V_notification.close();
            },

            _ifIncomingMsg(e) {
                if (e === this.myKey) return false;
                else return true;
            },

            _ifOutgoingMsg(e) {
                if (e === this.myKey) return true;
                else return false;
            },

            toggleDrawer() {
                this.dispatchEvent(new CustomEvent('toggleDrawer', {
                    bubbles: true, composed: true, detail: {
                        narrow: this.$.narrow
                    }
                }));
                this.$.narrow = !this.$.narrow;
            }

        })
    </script>
</dom-module>